<div class="flex items-center" *ngIf="army() && !loading()">

  <div class="flex items-center ml-auto gap-2">

    <button type="button" class="btn-tertiary !px-1 flex" matTooltip="Expand All" aria-label="Expand All" (click)="expandAll()">
      <app-icon pack="shared" icon="add-alt" size="md" class="mr-1"></app-icon>
    </button>

    <button type="button" class="btn-tertiary !px-1" matTooltip="Collapse All" aria-label="Collapse All" (click)="collapseAll()">
      <app-icon pack="shared" icon="subtract-alt" size="md" class="mr-1"></app-icon>
    </button>

    <button type="button" class="btn-tertiary !px-1" aria-label="Save Only" matTooltip="Save" (click)="save(false)">
      <app-icon *ngIf="saving() != 'saveOnly'" pack="shared" icon="save"></app-icon>
      <mat-spinner *ngIf="saving() == 'saveOnly'" diameter="20"></mat-spinner>
    </button>

    <button class="btn-tertiary !px-1 md:!px-3" [matMenuTriggerFor]="menu" aria-label="Settings">
      <app-icon pack="shared" icon="settings" size="md" class="mr-1"></app-icon>
      <span class="hidden md:block">Settings</span>
    </button>
    <mat-menu #menu="matMenu" class="!bg-white">
      <button type="button" class="btn btn-tertiary !rounded-none" (click)="delete()">
        <app-icon pack="shared" icon="trash" size="sm" class="mr-1"></app-icon>
        Delete Army
      </button>
    </mat-menu>

    <button type="button" class="btn-primary text-truncate" (click)="save(true)">
      <app-icon *ngIf="saving() != 'saveAndClose'" pack="shared" icon="save" class="mr-1"></app-icon>
      <mat-spinner *ngIf="saving() == 'saveAndClose'" diameter="20"></mat-spinner>
      Save and Close
    </button>

  </div>

</div>

<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded" role="alert" *ngIf="error">
  <p class="font-bold !mb-0">Error</p>
  <p class="!mb-0">{{error.message ?? error}}</p>
</div>

<div class="flex items-center mt-4">
  <a
    class="flex items-center flex-1 min-w-0 text-lg font-semibold cursor-pointer group mr-2"
    (click)="editArmyDetails()"
  >
    <span class="truncate">
      {{ army()?.name }}
    </span>
    <app-icon
      pack="shared"
      icon="edit"
      size="sm"
      class="text-primary-500 opacity-0 group-hover:opacity-100 transition-opacity ml-1 flex-shrink-0"
    ></app-icon>
  </a>
  <p class="ml-auto text-gray-700 font-semibold text-md flex-shrink-0">
    {{ totalCost() | number }} Pts
  </p>
</div>
<p class="text-sm text-gray-500">
  {{army()?.description}}
</p>

<mat-progress-bar mode="indeterminate" *ngIf="loading()"></mat-progress-bar>

<div class="mt-3" *ngIf="!loading()">

  <!-- Unit Card - Commander -->

  <mat-accordion cdkDropList [cdkDropListData]="platoons()" (cdkDropListDropped)="drop($event)" [multi]="multiExpand()" #platoonAccordion>
    <mat-expansion-panel *ngFor="let platoon of platoons(); let i = index" cdkDrag #platoonPanel class="!bg-white">
      <mat-expansion-panel-header>
        <div class="flex w-full items-center mr-3">
          <div class="drag-handle" cdkDragHandle>
            <mat-icon>drag_indicator</mat-icon>
          </div>
          <div class="truncate">
            {{ platoon.name }}
          </div>
          <app-icon pack="shared" icon="warning-filled" class="ml-1 text-red-400" *ngIf="platoon.hasErrors$ | async"></app-icon>
          <div class="ml-auto text-gray-700 text-sm">
            {{platoon.cost$ | async | number}} Pts
          </div>
        </div>
      </mat-expansion-panel-header>

      <!-- Load the PlatoonComponent for each platoon -->
      <app-platoon [platoon]="platoon" [library]="library"></app-platoon>

      <mat-action-row class="!border-t-2 !border-gray-100 space-x-2">
        <button class="btn-tertiary text-sm flex items-center px-4 py-2" (click)="deletePlatoon(i)">
          <app-icon pack="shared" icon="trash" size="sm" class="mr-1"></app-icon>
          Delete Platoon
        </button>
        <button class="btn-secondary text-sm flex items-center px-4 py-2" (click)="copyPlatoon(i)">
          <app-icon pack="shared" icon="copy" size="sm" class="mr-1"></app-icon>
          Duplicate
        </button>
      </mat-action-row>

    </mat-expansion-panel>

    <!-- Add Platoon Button -->
    <div class="mt-3">
      <button type="button" class="btn-primary" [matMenuTriggerFor]="addPlatoonMenu">
        + Add Platoon
      </button>

      <mat-menu #addPlatoonMenu="matMenu" class="!bg-gray-50">
        <button type="button" mat-menu-item *ngFor="let platoon of library.platoonSelectors" (click)="addPlatoon(platoon)">
          {{ platoon.name }}
        </button>
      </mat-menu>

    </div>
  </mat-accordion>

</div>

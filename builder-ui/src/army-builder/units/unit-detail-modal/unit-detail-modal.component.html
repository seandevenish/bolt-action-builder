<!-- Header -->
<div class="bg-gray-100 px-5 py-3 flex items-center justify-between border-b dark:border-gray-600">

  <div>
    <h2 class="font-semibold text-gray-800 text-lg truncate mt-1">{{unit.selector.name}}</h2>
    <p class="text-sm text-gray-700">{{cost() | number}} Pts</p>
  </div>

  <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" (click)="cancel()">
    <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
    </svg>
    <span class="sr-only">Close modal</span>
  </button>
</div>

<form [formGroup]="form" (submit)="submit()">

  <!-- Body -->
  <div class="p-5 w-full bg-white">

    <div class="space-y-3">

      <!-- Experience Selector -->
      <div class="inline-flex rounded">
        <div class="inline-block" *ngFor="let exp of unit.selector?.availableExperienceLevels; let i = index">
          <input type="radio" [id]="exp" [value]="exp" class="hidden peer" required formControlName="experience" />
          <label [for]="exp" class="text-sm text-center inline-block p-2.5 text-gray-500 bg-gray-50 cursor-pointer border border-gray-300
            peer-checked:bg-gray-600 peer-checked:text-gray-100 peer-checked:border-gray-600
            hover:text-gray-900 hover:bg-gray-200"
            [ngClass]="{
              'rounded-l-sm': i === 0,
              'rounded-r-sm': i === (unit.selector.availableExperienceLevels.length - 1),
              'border-r-0': i < (unit.selector.availableExperienceLevels.length - 1)
            }">
            <div>{{exp}}</div>
            <div class="text-xs">{{(unit.selector.cost[exp]) + ((infantryUnitSelector?.costPerMan?.[exp] ?? 0) * ((calculatedUnit().men ?? 0) - (infantryUnitSelector?.baseMen ?? 0))) | number}} Pts</div>
          </label>
        </div>
      </div>

      <!-- Infantry-specific controls -->
      <ng-container *ngIf="infantryUnitSelector && infantryUnit">

        <!-- Number of Men Selection -->
        <div class="grid grid-cols-6 gap-x-6 gap-y-8">
          <div class="col-span-3 md:col-span-2">
            <label for="men" class="block mb-2 text-sm font-medium text-gray-900">
              Number of Men
              <div class="text-xs text-gray-400">(Including {{infantryUnitSelector.keyPerson}})</div>
            </label>

            <select id="men" formControlName="men" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
              <option *ngFor="let men of [].constructor(infantryUnitSelector.maxMen - infantryUnitSelector.baseMen + 1); let i = index"
                [value]="infantryUnitSelector.baseMen + i">
                {{ infantryUnitSelector.baseMen + i }}
              </option>
            </select>
            <p id="helper-text-explanation" class="mt-1 text-sm text-gray-500">{{ infantryUnitSelector.costPerMan[experience] | number }} pts per man</p>
          </div>
        </div>

        <h3 class="font-semibold text-gray-800 pt-5" *ngIf="hasWeapons">Weapons</h3>

        <div class="border-l-4 border-primary-300 pl-3">
          <div class="grid grid-cols-6 gap-x-6 gap-y-8 mb-6">

            <!-- Default Weapon -->
            <div class="col-span-4 md:col-span-3">
              <label for="men" class="block mb-2 text-sm font-medium text-gray-900">Default Weapon</label>
              <p class="bg-gray-200 border border-gray-300 text-gray-900 text-sm rounded block w-full p-2.5">{{infantryUnitSelector.baseWeapon?.name}}</p>
            </div>


            <!-- Key Person Weapon Option -->
            <div class="col-span-4 md:col-span-3" *ngIf="infantryUnit.keyPersonWeaponOptions?.length">
              <label for="men" class="block mb-2 text-sm font-medium text-gray-900">{{infantryUnitSelector.keyPerson}} Weapon</label>
              <select id="men" formControlName="keyPersonWeaponId"
                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                <option [value]="null">{{infantryUnitSelector.baseWeapon?.name}}</option>
                <option *ngFor="let option of infantryUnitSelector.keyPersonWeaponOptions"
                  [value]="option.weaponId">
                  {{ option.description ?? option.weapon?.name }} ({{option.cost ? option.cost + ' Pts' : 'No Cost'}})
                </option>
              </select>
            </div>
          </div>

          <!-- Weapon Options -->
          <div class="grid grid-cols-6 gap-x-6 gap-y-8" formGroupName="generalWeaponIds">
            <div class="col-span-3 md:col-span-2 flex flex-col justify-between" *ngFor="let wOption of infantryUnitSelector.generalWeaponOptions">
              <label [for]="wOption.weaponId" class="block mb-2 text-sm font-medium text-gray-900 mt-auto">
                {{ wOption.description ?? wOption.weapon?.name }}
              </label>
              <select [id]="wOption.weaponId" [formControlName]="wOption.weaponId"
                      class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                <option *ngFor="let qty of [].constructor(wOption.max + 1); let i = index" [value]="i">
                  {{ i }}
                </option>
              </select>
              <p class="mt-1 text-sm text-gray-500">{{ wOption.cost | number }} pts each</p>
            </div>
          </div>
        </div>

      </ng-container>


      <!-- Vehicle Weapon Options -->
      <ng-container *ngIf="vehicleUnitSelector?.weaponOptions?.length">
        <h3 class="font-semibold text-gray-800 pt-5">Weapon Options</h3>
        <div class="space-y-4 border-l-4 border-primary-300 pl-3" formGroupName="weaponOptionIds">

          <!-- Loop through weapon options -->
          <div *ngFor="let option of vehicleUnitSelector!.weaponOptions; let i = index" class="relative">

            <!-- Ungrouped Options -->
            <ng-container *ngIf="!option.optionSetId">
              <div class="flex items-center pl-0">
                <input type="checkbox" [id]="option.id" [formControlName]="option.id"
                  class="w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-primary-500">
                <label [for]="option.id" class="ms-2 text-sm text-gray-900">
                  <span [innerHTML]="option.description"></span>
                </label>
              </div>
            </ng-container>

            <!-- Grouped Options -->
            <ng-container *ngIf="option.optionSetId">
              <div class="flex flex-col">
                <!-- Vertical Connector Line -->
                <div *ngIf="!isFirstInGroup(vehicleUnitSelector!.weaponOptions, option.optionSetId, i)"
                     class="ml-2 my-1 h-2 -mt-3 border-l w-2 border-gray-300"></div>

                <!-- Radio Input and Label -->
                <div class="flex items-center">
                  <input type="radio" [id]="option.id" [formControlName]="option.optionSetId" [value]="option.id"
                  (click)="toggleSelection(option.optionSetId, option.id)"
                    class="w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-primary-500">
                  <label [for]="option.id" class="ms-2 text-sm text-gray-900">
                    <span [innerHTML]="option.description"></span>
                  </label>
                </div>
              </div>
            </ng-container>

          </div>
        </div>
      </ng-container>


      <!-- General Options -->
      <ng-container *ngIf="selector.options?.length">
        <h3 class="font-semibold text-gray-800 pt-5">Options</h3>
        <div class="space-y-4 border-l-4 border-primary-300 pl-3" formGroupName="optionIds">
          <div class="flex items-center" *ngFor="let option of selector.options">
            <input type="checkbox" [id]="option.id" [formControlName]="option.id"
              class="w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-primary-500 dark:focus:ring-primary-600 dark:ring-offset-gray-800 dark:focus:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
            <label [for]="option.id" class="ms-2 text-sm text-gray-900 dark:text-gray-300">
              <span [innerHTML]="option.description"></span>
            </label>
          </div>
        </div>
      </ng-container>

      <!-- Validation Errors -->
      <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4" role="alert" *ngIf="validationErrors()">
        <p class="font-bold !mb-0">Invalid Unit Selection</p>
        <p class="!mb-0" *ngFor="let error of validationErrors()" [innerHTML]="error"></p>
      </div>

      <!-- Unit Summary -->
      <h3 class="font-semibold text-gray-800 pt-5">Summary</h3>

      <span class="text-sm text-gray-700 mr-2">
        {{calculatedUnit().countString}}
      </span>
      <span class="text-sm text-gray-700 bg-gray-300 rounded-sm px-2 py-0.5">
        {{calculatedUnit().experience}}
      </span>

      <div class="text-sm text-gray-700" *ngIf="vehicleUnitSelector">
        <div class="flex">
          <div>{{vehicleUnitSelector.damageValue}}+ Damage</div>
          <div class="ml-auto" *ngIf="vehicleUnitSelector.transportCapacity">Transports {{vehicleUnitSelector.transportCapacity}}</div>
        </div>
        <div class="text-xs" *ngIf="vehicleUnitSelector.tow"><strong>Tows</strong> {{vehicleUnitSelector.tow}}</div>
      </div>

      <p class="text-sm">
        <ng-container *ngFor="let rule of calculatedUnit().specialRules; let last = last">
          {{rule.name}}{{!last ? ', ' : ''}}
        </ng-container>
      </p>

      <div class="container text-sm" *ngIf="calculatedUnit().weaponSummary.length">
        <div class="overflow-x-auto">
          <table class="table-auto w-full text-center">
            <thead class="bg-gray-100">
              <tr class="text-gray-600 border-b border-t border-gray-200">
                <th class="px-3 py-2 font-bold">Qty</th>
                <th class="px-3 py-2 font-bold text-left">Weapons</th>
                <th class="px-3 py-2 font-bold">Range</th>
                <th class="px-3 py-2 font-bold">Shots</th>
                <th class="px-3 py-2 font-bold">Pen</th>
                <th class="px-3 py-2 font-bold text-left">Special</th>
              </tr>
            </thead>
            <tbody>
              <tr class="hover:bg-gray-50 border-b border-gray-200" *ngFor="let row of calculatedUnit().weaponSummary">
                <td class="px-3 py-2">{{row.qty | number}}{{row.role ? ' ' + row.role : ''}}</td>
                <td class="px-3 py-2 text-left">{{row.description}}</td>
                <td class="px-3 py-2">{{row.weapon.range}}"</td>
                <td class="px-3 py-2">{{row.weapon.shots}}</td>
                <td class="px-3 py-2">{{row.weapon.penetrationValue}}</td>
                <td class="px-3 py-2 text-left">{{row.special}}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <!-- Footer -->
  <div class="w-full flex justify-between items-center bg-gray-50 border-t border-gray-200 px-5 py-3">
    <!-- Left-aligned Delete button -->
    <button type="button" class="btn-tertiary" (click)="delete()">
     <app-icon pack="shared" icon="trash" size="sm" class="mr-1"></app-icon>
      Delete
    </button>

    <!-- Right-aligned Save and Cancel buttons -->
    <div class="flex space-x-2">
      <button type="submit" class="btn-primary">
        Save
      </button>
      <button type="button" class="btn-secondary" (click)="cancel()">
        Cancel
      </button>
    </div>
  </div>

</form>

